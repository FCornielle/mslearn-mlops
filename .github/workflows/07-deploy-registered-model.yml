name: Deploy production model

on:
  workflow_dispatch:

jobs:
  deploy:
    name: Deploy model to online endpoint
    runs-on: ubuntu-latest
    environment: production

    steps:
    - name: Checkout repository
      uses: actions/checkout@v3

    - name: Azure login (Production)
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_PROD_CREDENTIALS }}

    - name: Install Azure ML extension
      run: az extension add -n ml -y

    - name: Create online endpoint (idempotent)
      run: |
        az ml online-endpoint create \
          --name diabetes-endpoint \
          --auth-mode key \
          --resource-group mslearn-prod-mlops-rg \
          --workspace-name mslearn-prod-mlops-aml \
        || true

    - name: Deploy latest model
      run: |
        az ml online-deployment create \
          --endpoint-name diabetes-endpoint \
          --name blue \
          --model diabetes_prod_model:latest \
          --instance-type Standard_DS1_v2 \
          --instance-count 1 \
          --traffic 100 \
          --resource-group mslearn-prod-mlops-rg \
          --workspace-name mslearn-prod-mlops-aml \
          --no-wait
